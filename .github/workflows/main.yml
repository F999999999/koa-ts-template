# å·¥ä½œæµåç§°ï¼ˆé»˜è®¤å€¼ï¼šé…ç½®æ–‡ä»¶åï¼‰
name: GitHub Actions Deploy koa-serve main

# æŒ‡å®šè§¦å‘ å·¥ä½œæµï¼ˆworkflowï¼‰çš„æ¡ä»¶
# æŒ‡å®šè§¦å‘äº‹ä»¶æ—¶ï¼Œå¯ä»¥é™å®šåˆ†æ”¯æˆ–æ ‡ç­¾
on:
  # å½“è§¦å‘ push äº‹ä»¶æ—¶æ‰§è¡Œå·¥ä½œæµä»»åŠ¡
  push:
    # å½“åˆ†æ”¯æ˜¯ main æ—¶æ‰§è¡Œå·¥ä½œæµä»»åŠ¡
    branches:
      - main

# å·¥ä½œæµä»»åŠ¡
jobs:
  # ä»»åŠ¡åç§°
  build:
    # ä»»åŠ¡è¿è¡Œçš„å®¹å™¨ç±»å‹ï¼ˆè™šæ‹Ÿæœºç¯å¢ƒï¼‰
    runs-on: ubuntu-latest

    # åˆ¤æ–­åœ¨æŒ‡å®šç”¨æˆ·æˆ–è€…ç»„ç»‡çš„æŒ‡å®šä»“åº“ä¸­æ‰æ‰§è¡Œ
    if: github.repository == 'F999999999/ä»“åº“åç§°'
    # åˆ¤æ–­åœ¨æŒ‡å®šç”¨æˆ·æˆ–è€…ç»„ç»‡ä¸­æ‰æ‰§è¡Œ
    # if: github.repository_owner == 'ç”¨æˆ·åæˆ–è€…ç»„ç»‡å'

    # æŒ‡å®šä»»åŠ¡æ‰§è¡Œçš„å‘½ä»¤
    steps:
      # æ‹‰å–ä»£ç 
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          # æ˜¯å¦åœ¨git config ä¸­æŒä¹…åŒ– tokenï¼ˆé»˜è®¤å€¼ï¼štrueï¼‰
          persist-credentials: false

      # è®¾ç½® node ç¯å¢ƒå˜é‡
      - name: Setup Node.js âš™
        uses: actions/setup-node@v1
        with:
          # éœ€è¦ä½¿ç”¨çš„ node ç‰ˆæœ¬
          node-version: 16

      # è·å–ç¼“å­˜è·¯å¾„
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      # ç¼“å­˜ yarn
      - name: Cache yarn cache ğŸ’¾
        uses: actions/cache@v2
        id: cache-yarn-cache
        with:
          # éœ€è¦ç¼“å­˜çš„æ–‡ä»¶ã€ç›®å½•å’Œé€šé…ç¬¦æ¨¡å¼åˆ—è¡¨
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          # ç”¨äºæ¢å¤å’Œä¿å­˜ç¼“å­˜çš„æ˜¾å¼å¯†é’¥
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          # å¦‚æœé”®æ²¡æœ‰å‘ç”Ÿç¼“å­˜å‘½ä¸­ï¼Œåˆ™ç”¨äºæ¢å¤ç¼“å­˜çš„é”®çš„æ˜¾å¼å¯†é’¥
          restore-keys: |
            ${{ runner.os }}-yarn-

      # ç¼“å­˜ä¾èµ–æ–‡ä»¶
      - name: Cache node_modules ğŸ’¾
        id: cache-node-modules
        uses: actions/cache@v2
        with:
          # éœ€è¦ç¼“å­˜çš„æ–‡ä»¶ã€ç›®å½•å’Œé€šé…ç¬¦æ¨¡å¼åˆ—è¡¨
          path: node_modules
          # ç”¨äºæ¢å¤å’Œä¿å­˜ç¼“å­˜çš„æ˜¾å¼å¯†é’¥
          key: ${{ runner.os }}-${{ matrix.node-version }}-nodemodules-${{ hashFiles('**/yarn.lock') }}
          # å¦‚æœé”®æ²¡æœ‰å‘ç”Ÿç¼“å­˜å‘½ä¸­ï¼Œåˆ™ç”¨äºæ¢å¤ç¼“å­˜çš„é”®çš„æ˜¾å¼å¯†é’¥
          restore-keys: |
            ${{ runner.os }}-${{ matrix.node-version }}-nodemodules-

      # å®‰è£…ä¾èµ–
      - name: Install dependencies ğŸ”§
        # åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­
        if: |
          steps.cache-yarn-cache.outputs.cache-hit != 'true' ||
          steps.cache-node-modules.outputs.cache-hit != 'true'
        # å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œåˆ™å®‰è£…ä¾èµ–
        run: yarn

      # æ‰“åŒ…å¹¶å‹ç¼©
      - name: Packaging ğŸ“¦
        run: tar czvf release.tar.gz *

      # ä¸Šä¼ åˆ°æœåŠ¡å™¨
      - name: Deploy ğŸš€
        # æ„å»º
        uses: easingthemes/ssh-deploy@v2.1.5
        # è¯¥æ­¥éª¤æ‰€éœ€çš„ç¯å¢ƒå˜é‡
        env:
          # æœåŠ¡å™¨åœ°å€(IPæˆ–è€…åŸŸå)
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          # æœåŠ¡å™¨ç”¨æˆ·å
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          # æœåŠ¡å™¨ SSH ç§é’¥
          SSH_PRIVATE_KEY: ${{ secrets.REMOTE_SSH_KEY }}
          # æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„
          TARGET: ${{ secrets.REMOTE_TARGET }}
          # æºç›®å½•ï¼ˆæ‰“åŒ…çš„ç›®å½•æˆ–æ–‡ä»¶ï¼‰
          SOURCE: "release.tar.gz"
          # rsync flagsï¼ˆé»˜è®¤å€¼ï¼š"-rltgoDzvO"ï¼‰
          # --delete åˆ é™¤é‚£äº›ç›®æ ‡ç›®å½•ä¸­æœ‰è€Œæºç›®å½•ä¸­æ²¡æœ‰çš„å¤šä½™æ–‡ä»¶
          # --exclude æ’é™¤ç›®æ ‡ç›®å½•ä¸­é‚£äº›è¢«è¯¥é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶
          ARGS: "-rltgoDzvO --delete --exclude '.env'"

      # éƒ¨ç½²æœåŠ¡å™¨
      - name: Deploy ğŸ‰
        # æ„å»º
        uses: appleboy/ssh-action@master
        with:
          # æœåŠ¡å™¨åœ°å€(IPæˆ–è€…åŸŸå)
          host: ${{ secrets.REMOTE_HOST }}
          # æœåŠ¡å™¨ç”¨æˆ·å
          username: ${{ secrets.REMOTE_USER }}
          # æœåŠ¡å™¨ SSH ç§é’¥
          key: ${{ secrets.REMOTE_SSH_KEY }}
          # è¿è¡Œåœ¨è¿œç¨‹æœåŠ¡å™¨çš„å‘½ä»¤
          # ä¸´æ—¶æ·»åŠ node/binç›®å½•åˆ°ç¯å¢ƒå˜é‡
          # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
          # å¼€å¯ extglob
          # åˆ é™¤æ—§æ–‡ä»¶
          # è§£å‹å‹ç¼©åŒ…
          # é‡è½½PM2
          # æ‰§è¡Œæ¸…ç†æ“ä½œ
          script: |
            export PATH=$PATH:${{ secrets.REMOTE_PATH }}
            cd ${{ secrets.REMOTE_TARGET }}
            shopt -s extglob
            rm -rf !(release.tar.gz|.env)
            tar xzf release.tar.gz
            pm2 reload ecosystem.config.js
            rm -rf release.tar.gz